<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shopMapper">

	<resultMap type="Shop" id="shop_rm">
		<id property="itemNo" column="ITEM_NO"></id>
	 	<result property="itemContent" column="ITEM_CONTENT"/>
 		<result property="itemNm" column="ITEM_NM"/>
 		<result property="itemPrice" column="ITEM_PRICE"/>
 		<result property="transCharge" column="TRANSPORT_CHARGE"/>
 		<result property="itemDeleteFl" column="ITEM_DELETE_FL"/>
 		<result property="itemCreateDt" column="ITEM_CREATE_DT"/>
 		<result property="itemCategory" column="ITEM_CATEGORY"/>
 		<result property="itemCategoryNm" column="CATEGORY_NM"/>
	</resultMap>

	<resultMap type="ShopOption" id="shopoption_rm">
		<result property="optionNo" column="OPTION_NO"/>
		<result property="itemOptionContent" column="ITEM_OPTION_CONTENT"/>
		<result property="itemNo" column="ITEM_NO"/>
		<result property="optionSpecifyContent" column="OPTION_SPECIFY_CONTENT"/>
		<result property="optionNo" column="OPTION_NO"/>
	</resultMap>		

		<resultMap type="ShopAttachment" id="shopattachment_rm">
			<id property="fileNo" column="IMG_NO"/>
			<result property="filePath" column="IMG_PATH"/>
			<result property="fileName" column="IMG_NAME"/>
			<result property="fileLevel" column="IMG_LEVEL"/>
			<result property="parentShopNo" column="ITEM_NO"/>
		</resultMap>	
		
		<resultMap type="ShopScore" id="shopscore_rm">
			<result property="score" column="SCORE"/>
			<result property="itemNo" column="ITEM_NO"/>
		</resultMap>	


	<!-- 특정 게시판 전체 게시글 수 조회 -->
	<select id="getListCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*) FROM V_ITEM
		WHERE ITEM_DELETE_FL = 'N'
		AND ITEM_CATEGORY = #{type}
	</select>
	
	<!-- shop 게시글 목록 조회 -->
	<select id="selectShopList" parameterType="_int" resultMap="shop_rm">
			SELECT ITEM_NO,ITEM_NM,ITEM_PRICE,TRANSPORT_CHARGE
			FROM V_ITEM
			WHERE ITEM_DELETE_FL = 'N'
			AND ITEM_CATEGORY = #{type}
			ORDER BY ITEM_NO DESC
	</select>
	
	<!-- Shop 썸네일 목록 조회 -->
	<select id="selectShopThumnailList" parameterType="list" resultMap="shopattachment_rm">
			SELECT * FROM EH_ITEM_IMG
			WHERE IMG_LEVEL = 0
			AND ITEM_NO IN
			<foreach collection="list" item="shop" open="(" close=")" separator="," >
			 #{shop.itemNo}				
			</foreach>	
	</select>
	

  <!-- shop 게시글 상세 조회 -->
  <select id="selectShopBoard" parameterType="Shop" resultMap="shop_rm">
     SELECT ITEM_NO,ITEM_NM,ITEM_PRICE,ITEM_CONTENT,
						TRANSPORT_CHARGE,CATEGORY_NM
		 FROM V_ITEM
		 WHERE ITEM_DELETE_FL = 'N' 
		 AND ITEM_NO = #{itemNo}
		 AND ITEM_CATEGORY =#{itemCategory}
  </select>


	<!-- 게시글에  포함된 이미지 목록 조회  -->
		<select id="selectShopAttachmentList" parameterType="_int" resultMap="shopattachment_rm">
			SELECT * FROM EH_ITEM_IMG
			WHERE ITEM_NO = #{itemNo}
			AND IMG_LEVEL=0
		</select>

<!-- Shop  포함된  옵션  목록  조회  -->
<select id="selectShopOptionList" parameterType="_int" resultMap="shopoption_rm">
	SELECT * FROM V_ITEM_OPTION
	WHERE ITEM_NO=#{itemNo}
</select>


	<!-- shop 다음게시글 번호 조회 -->
		<select id="selectShopNextNo" resultType="_int">
			SELECT SEQ_IT_NO.NEXTVAL FROM DUAL 
		</select>

	<!-- shop 게시글 삽입 -->
	<insert id="insertShopBoard" parameterType="map">
		INSERT INTO EH_ITEM VALUES
		(#{shopNo},#{shopContent},#{shopItemNm},#{shopItemPrice},
		 #{shopTransCharge},DEFAULT,DEFAULT,
		 #{shopCategory})
	</insert>
	
	<!-- shop 옵션번호 추가 -->
	 <insert id="insertOption" parameterType="_int">
	  INSERT INTO EH_ITEM_OPTION 
	  VALUES(SEQ_IT_OPTIONNO.NEXTVAL,'옵션',#{shopNo})
	 </insert>
	 
	 	<!-- shop 옵션번호 추가 -->
	 <select id="selectOptionNo" parameterType="_int" resultType="_int">
	  SELECT OPTION_NO
	  FROM
	  EH_ITEM_OPTION 
	  WHERE ITEM_NO = #{ShopNo}
	 </select>


	<!-- shop 옵션상세내용추가 -->
	 <insert id="insertOptionDetail" parameterType="list">
	  INSERT INTO EH_ITEM_OPTIONDETAIL 
	  	SELECT SEQ_IT_OPTION_DENO.NEXTVAL, A.* FROM (
				<foreach collection="list" item="item"  separator=" UNION ALL ">
					SELECT #{item.optionSpecifyContent} OPTION_SPECIFY_CONTENT,
								 #{item.optionNo} OPTION_NO
					FROM DUAL	
				</foreach>
			)A
	 </insert>

	
		<!-- 파일 정보 삽입(List 이용)-->
		<insert id="insertShopAttachmentList" parameterType="list">
			INSERT INTO EH_ITEM_IMG
			SELECT SEQ_IT_IMGNO.NEXTVAL, A.* FROM (
				<foreach collection="list" item="item"  separator=" UNION ALL ">
					SELECT #{item.fileName} IMG_NAME,
								 #{item.filePath} IMG_PATH,
								 #{item.fileLevel} IMG_LEVEL,
								 #{item.parentShopNo} ITEM_NO
					FROM DUAL	
				</foreach>
			)A
		</insert>

	<!-- Shop 게시글 수정 -->
<update id="updateShopBoard" parameterType="Shop">
	UPDATE EH_ITEM SET
	ITEM_NM = #{itemNm},
	ITEM_CONTENT = #{itemContent},
	ITEM_PRICE = #{itemPrice},
	TRANSPORT_CHARGE =#{transCharge},
	ITEM_CATEGORY = #{itemCategory}
	WHERE ITEM_NO = #{itemNo}
</update>	

 <!-- Shop 파일 정보 수정 -->
<update id="updateShopAttachment" parameterType="ShopAttachment">
	UPDATE EH_ITEM_IMG SET
	IMG_NAME =#{fileName},
	IMG_PATH =#{filePath}
	WHERE IMG_NO = #{fileNo}
</update>


 <!-- Shop 파일 정보 수정 summernote -->
<select id="selectShopSummernoteImg" parameterType="_int" resultMap="shopattachment_rm">
	SELECT * FROM EH_ITEM_IMG
	WHERE ITEM_NO = #{itemNo}
</select>

<!--섬머노트 파일 정보 일괄  삭제 -->
<delete id="deleteShopAttachmentList" parameterType="list">
	DELETE FROM EH_ITEM_IMG 
	WHERE IMG_NO IN
	<foreach collection="list" item="fileNo" open="(" close=")" separator=",">
	#{fileNo}	
	</foreach>
</delete>




	<!-- shop  메인 게시글 목록 조회 -->
	<select id="selectShopMainList" resultMap="shop_rm">
		SELECT * 
		FROM V_ITEM
	  WHERE ROWNUM<![CDATA[<=]]>3  
		AND ITEM_DELETE_FL = 'N'
		ORDER BY ITEM_NO DESC
	</select>


	<!-- Shop 메인 썸네일  목록 조회 -->
	<select id="selectShopMainThList" parameterType="list" resultMap="shopattachment_rm">
			SELECT * FROM<![CDATA[
			 (SELECT * FROM
				EH_ITEM_IMG 
				ORDER BY ITEM_NO DESC
			)]]>
			WHERE IMG_LEVEL=0
	  	AND ROWNUM<![CDATA[<=]]>3  
			AND ITEM_NO IN
			<foreach collection="list" item="shop" open="(" close=")" separator="," >
			 #{shop.itemNo}				
			</foreach>	
	</select>
	
	
  	<!-- ShopList 별점 조회  -->
	<select id="selectShopScore" parameterType="list" resultMap="shopscore_rm">
		SELECT
		AVG(IT_REV_RATING) SCORE, ITEM_NO
		FROM EH_ITEM_REVIEW
		JOIN EH_ITEM USING(ITEM_NO)
		JOIN EH_ITEM_CATEGORY USING(ITEM_CATEGORY)
		WHERE ITEM_NO IN
		<foreach collection="list" item="shop" open="(" close=")" separator="," >
		  #{shop.itemNo}				
	    </foreach>	
		GROUP BY ITEM_NO
	</select>
	
	
	
	
	


</mapper>